<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda - ProductManagement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; }
        .navbar { background: #1e293b !important; }
        .product-card { border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
        .product-card:hover { transform: translateY(-6px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .product-img { height: 200px; object-fit: cover; width: 100%; }
        .product-img-placeholder { height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; }
        .cart-fab { position: fixed; bottom: 30px; right: 30px; z-index: 999; width: 60px; height: 60px; border-radius: 50%; font-size: 1.4rem; box-shadow: 0 4px 15px rgba(0,0,0,0.25); }
        .price { font-size: 1.4rem; font-weight: 800; color: #3b82f6; }
        .hero { background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%); color: white; padding: 70px 0 50px; }
        .categoria-pill { padding: 8px 20px; border-radius: 25px; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s; font-weight: 600; background: white; }
        .categoria-pill:hover, .categoria-pill.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .cart-item-row { border-bottom: 1px solid #f1f5f9; padding: 12px 0; }
        .detail-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; }
        body.dark { background: #0f172a !important; color: #e2e8f0; }
        body.dark .product-card { background: #1e293b; color: #e2e8f0; }
        body.dark .card { background: #1e293b; color: #e2e8f0; }
        body.dark .text-muted { color: #94a3b8 !important; }
        body.dark .modal-content { background: #1e293b; color: #e2e8f0; }
        body.dark .modal-header { border-color: #334155; }
        body.dark .modal-footer { border-color: #334155; }
        body.dark .form-control { background: #0f172a; color: #e2e8f0; border-color: #334155; }
        body.dark .form-control::placeholder { color: #64748b; }
        body.dark .card.bg-light { background: #0f172a !important; }
        body.dark .alert-warning { background: #422006; border-color: #92400e; color: #fde68a; }
        body.dark .alert-info { background: #0c2d48; border-color: #1e40af; color: #bfdbfe; }
        body.dark .categoria-pill { background: #1e293b; border-color: #334155; color: #e2e8f0; }
        body.dark .categoria-pill.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        body.dark .table { color: #e2e8f0; }
        body.dark input, body.dark textarea, body.dark select { background: #0f172a !important; color: #e2e8f0 !important; border-color: #334155 !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold fs-5" href="#"><i class="bi bi-box-seam me-2"></i>Titan Store</a>
        <div class="d-flex gap-2 align-items-center">
            <a href="/contacto.html" class="btn btn-outline-light btn-sm"><i class="bi bi-envelope me-1"></i>Contacto</a>
            <button class="btn btn-outline-light btn-sm" onclick="toggleDarkMode()" id="darkBtn"><i class="bi bi-moon-fill"></i></button>
        </div>
    </div>
</nav>

<div class="hero">
    <div class="container text-center">
        <h1 class="fw-bold mb-2">üõí Nuestra Tienda</h1>
        <p class="opacity-75 mb-4">Los mejores productos al mejor precio</p>
        <input type="text" id="searchInput" class="form-control form-control-lg w-50 mx-auto" placeholder="üîç Buscar productos..." oninput="filterProducts()">
    </div>
</div>

<div class="container my-4">
    <div class="d-flex gap-2 flex-wrap mb-4" id="categoriasPills">
        <button class="categoria-pill active" onclick="filterByCategoria('', this)">Todos</button>
    </div>
    <div id="loadingMsg" class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Cargando productos...</p></div>
    <div class="row g-4" id="productsGrid"></div>
</div>

<!-- CART FAB -->
<button class="btn btn-primary cart-fab position-relative" onclick="openCart()">
    <i class="bi bi-cart3"></i>
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartBadge">0</span>
</button>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header border-0"><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="detailBody"></div>
    </div></div>
</div>

<!-- CART MODAL -->
<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-cart3 me-2"></i>Carrito de Compras</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="cartBody"></div>
        <div class="modal-footer">
            <div class="me-auto fw-bold fs-5">Total: <span class="text-primary" id="cartTotal">$0</span></div>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Seguir comprando</button>
            <button class="btn btn-success" onclick="openCheckout()"><i class="bi bi-credit-card me-2"></i>Finalizar compra</button>
        </div>
    </div></div>
</div>

<!-- CHECKOUT MODAL -->
<!-- CHECKOUT MODAL -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Finalizar Compra</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div id="checkoutError" class="alert alert-danger d-none"></div>
            <div id="checkoutSuccess" class="alert alert-success d-none"></div>

            <!-- STEPS -->
            <div class="d-flex mb-4">
                <div class="text-center flex-fill" id="step1Indicator">
                    <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-1" style="width:32px;height:32px;">1</div>
                    <div class="small fw-semibold">Datos</div>
                </div>
                <div class="flex-fill d-flex align-items-center pb-4"><div class="w-100 border-top border-2"></div></div>
                <div class="text-center flex-fill" id="step2Indicator">
                    <div class="rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center mb-1" style="width:32px;height:32px;" id="step2Circle">2</div>
                    <div class="small text-muted" id="step2Label">Pago</div>
                </div>
                <div class="flex-fill d-flex align-items-center pb-4"><div class="w-100 border-top border-2"></div></div>
                <div class="text-center flex-fill">
                    <div class="rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center mb-1" style="width:32px;height:32px;" id="step3Circle">3</div>
                    <div class="small text-muted" id="step3Label">Confirmaci√≥n</div>
                </div>
            </div>

            <!-- STEP 1: DATOS -->
            <div id="stepDatos">
                <div class="mb-3"><label class="form-label fw-semibold">Nombre completo</label><input type="text" id="custName" class="form-control" placeholder="Juan P√©rez"></div>
                <div class="mb-3"><label class="form-label fw-semibold">Email</label><input type="email" id="custEmail" class="form-control" placeholder="juan@email.com"></div>
                <div class="mb-3"><label class="form-label fw-semibold">Tel√©fono / WhatsApp</label><input type="tel" id="custPhone" class="form-control" placeholder="+57 300 000 0000"></div>
                <div class="mb-3"><label class="form-label fw-semibold">Direcci√≥n de entrega</label><textarea id="custAddress" class="form-control" rows="2" placeholder="Calle 123 # 45-67, Ciudad"></textarea></div>
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold mb-2">Resumen del pedido</h6>
                        <div id="checkoutSummary"></div>
                        <div class="d-flex justify-content-between fw-bold mt-2 pt-2 border-top">
                            <span>Total a pagar:</span><span class="text-primary" id="checkoutTotal">$0</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary w-100" onclick="goToPayment()"><i class="bi bi-arrow-right me-2"></i>Continuar al pago</button>
            </div>

            <!-- STEP 2: PAGO -->
            <div id="stepPago" style="display:none;">
                <div class="text-center mb-4">
                    <h5 class="fw-bold mb-1">Paga con Nequi</h5>
                    <p class="text-muted small">Escanea el QR o env√≠a al n√∫mero registrado</p>
                    <!-- QR Nequi placeholder -->
                    <div class="border rounded-3 d-inline-block p-3 mb-3 bg-white shadow-sm">
                        <img src="/images/nequi-qr.jpg" style="width:180px;height:180px;border-radius:12px;object-fit:contain;" alt="QR Nequi">
                    </div>
                    <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
                        <div class="border rounded-3 p-3 bg-light text-center" style="min-width:160px;">
                            <i class="bi bi-phone fs-3 text-primary"></i>
                            <div class="fw-bold mt-1">3004051875</div>
                            <small class="text-muted">N√∫mero Nequi</small>
                        </div>
                        <div class="border rounded-3 p-3 bg-light text-center" style="min-width:160px;">
                            <span class="fw-bold fs-4 text-success" id="paymentTotal">$0</span>
                            <div><small class="text-muted">Monto exacto</small></div>
                        </div>
                    </div>
                    <div class="alert alert-warning text-start">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Instrucciones:</strong>
                        <ol class="mb-0 mt-1 small">
                            <li>Abre Nequi y escanea el QR o env√≠a al n√∫mero</li>
                            <li>Env√≠a exactamente el valor indicado</li>
                            <li>Toma captura del comprobante</li>
                            <li>Env√≠ala por WhatsApp al bot√≥n de abajo</li>
                        </ol>
                    </div>
                    <a id="whatsappLink" href="#" target="_blank" class="btn btn-success btn-lg w-100 mb-3">
                        <i class="bi bi-whatsapp me-2"></i>Enviar comprobante por WhatsApp
                    </a>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary flex-shrink-0" onclick="backToDatos()"><i class="bi bi-arrow-left"></i></button>
                    <button class="btn btn-primary w-100" onclick="placeOrder()"><i class="bi bi-check-circle me-2"></i>Ya pagu√©, confirmar pedido</button>
                </div>
            </div>

            <!-- STEP 3: CONFIRMACION -->
            <div id="stepConfirmacion" style="display:none;">
                <div class="text-center py-3">
                    <div class="bg-success rounded-circle d-inline-flex p-3 mb-3">
                        <i class="bi bi-check-lg text-white fs-2"></i>
                    </div>
                    <h4 class="fw-bold">¬°Pedido Confirmado!</h4>
                    <p class="text-muted" id="confirmMsg"></p>
                    <div class="alert alert-info text-start">
                        <i class="bi bi-whatsapp me-2 text-success"></i>
                        Recuerda enviar tu comprobante de pago por WhatsApp para procesar tu pedido m√°s r√°pido.
                    </div>
                    <a id="whatsappLink2" href="#" target="_blank" class="btn btn-success mb-2 w-100">
                        <i class="bi bi-whatsapp me-2"></i>Enviar comprobante
                    </a>
                    <button class="btn btn-outline-primary w-100" data-bs-dismiss="modal">Seguir comprando</button>
                </div>
            </div>

        </div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allProducts = [];
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let activeCategoria = '';

loadProducts();
updateCartUI();

async function loadProducts() {
    try {
        const res = await fetch('/api/Products/public');
        allProducts = await res.json();
        document.getElementById('loadingMsg').style.display = 'none';
        buildCategorias();
        renderProducts(allProducts);
    } catch(e) {
        document.getElementById('loadingMsg').innerHTML = '<p class="text-danger">Error al cargar productos</p>';
    }
}

function buildCategorias() {
    const cats = [...new Set(allProducts.map(p => p.categoria).filter(Boolean))];
    const container = document.getElementById('categoriasPills');
    cats.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'categoria-pill';
        btn.textContent = cat;
        btn.onclick = () => filterByCategoria(cat, btn);
        container.appendChild(btn);
    });
}

function filterByCategoria(cat, el) {
    activeCategoria = cat;
    document.querySelectorAll('.categoria-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    filterProducts();
}

function filterProducts() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    renderProducts(allProducts.filter(p =>
        (p.nombre.toLowerCase().includes(q) || p.descripcion.toLowerCase().includes(q)) &&
        (activeCategoria === '' || p.categoria === activeCategoria)
    ));
}

function renderProducts(products) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = products.length === 0 ? '<div class="col-12 text-center py-5"><i class="bi bi-search fs-1 text-muted"></i><p class="text-muted mt-2">No se encontraron productos</p></div>' :
        products.map(p => `
            <div class="col-md-4 col-sm-6">
                <div class="card product-card h-100">
                    ${p.imagenUrl
                        ? `<img src="${p.imagenUrl}" class="product-img" alt="${p.nombre}">`
                        : `<div class="product-img-placeholder"><i class="bi bi-box-seam text-white" style="font-size:3rem"></i></div>`}
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h5 class="fw-bold mb-0">${p.nombre}</h5>
                            <span class="badge bg-light text-primary border">${p.categoria||'General'}</span>
                        </div>
                        <p class="text-muted small flex-grow-1 mt-2">${p.descripcion}</p>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="price">$${p.precio.toLocaleString()}</span>
                            <span class="${p.stock > 5 ? 'text-success' : 'text-danger'} small fw-semibold">
                                <i class="bi bi-${p.stock > 5 ? 'check-circle' : 'exclamation-circle'}"></i>
                                ${p.stock > 0 ? p.stock + ' en stock' : 'Agotado'}
                            </span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm flex-shrink-0" onclick="viewDetail(${p.id})"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-primary w-100" ${p.stock===0?'disabled':''} onclick="addToCart(${p.id}, '${p.nombre}', ${p.precio})">
                                <i class="bi bi-cart-plus me-2"></i>${p.stock===0?'Agotado':'Agregar'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>`).join('');
}

function viewDetail(id) {
    const p = allProducts.find(x => x.id === id);
    if (!p) return;
    const inCart = cart.find(i => i.productId === id);
    document.getElementById('detailBody').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                ${p.imagenUrl
                    ? `<img src="${p.imagenUrl}" class="detail-img" alt="${p.nombre}">`
                    : `<div style="height:250px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;display:flex;align-items:center;justify-content:center;"><i class="bi bi-box-seam text-white" style="font-size:4rem"></i></div>`}
            </div>
            <div class="col-md-6 d-flex flex-column justify-content-center">
                <span class="badge bg-primary mb-2" style="width:fit-content">${p.categoria||'General'}</span>
                <h3 class="fw-bold">${p.nombre}</h3>
                <p class="text-muted">${p.descripcion}</p>
                <h2 class="fw-bold text-primary mb-3">$${p.precio.toLocaleString()}</h2>
                <p class="${p.stock > 5 ? 'text-success' : 'text-danger'} fw-semibold">
                    <i class="bi bi-${p.stock > 5 ? 'check-circle' : 'exclamation-circle'} me-1"></i>
                    ${p.stock > 0 ? p.stock + ' unidades disponibles' : 'Agotado'}
                </p>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-primary flex-grow-1" ${p.stock===0?'disabled':''} onclick="addToCart(${p.id},'${p.nombre}',${p.precio});bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">
                        <i class="bi bi-cart-plus me-2"></i>Agregar al carrito
                    </button>
                </div>
                ${inCart ? `<small class="text-success mt-2"><i class="bi bi-check-circle me-1"></i>Ya tienes ${inCart.quantity} en el carrito</small>` : ''}
            </div>
        </div>`;
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function addToCart(id, nombre, precio) {
    const existing = cart.find(i => i.productId === id);
    if (existing) existing.quantity++;
    else cart.push({ productId: id, productName: nombre, price: precio, quantity: 1 });
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartUI();
    showToast(`‚úÖ ${nombre} agregado`);
}

function updateCartUI() {
    const count = cart.reduce((s,i) => s+i.quantity, 0);
    document.getElementById('cartBadge').textContent = count;
    document.getElementById('cartCount').textContent = count + ' items';
}

function openCart() {
    const body = document.getElementById('cartBody');
    if (cart.length === 0) {
        body.innerHTML = '<div class="text-center py-4"><i class="bi bi-cart-x fs-1 text-muted"></i><p class="text-muted mt-2">Tu carrito est√° vac√≠o</p></div>';
    } else {
        body.innerHTML = cart.map(i => `
            <div class="cart-item-row d-flex justify-content-between align-items-center">
                <div><strong>${i.productName}</strong><div class="text-muted small">$${i.price.toLocaleString()} c/u</div></div>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(${i.productId},-1)">-</button>
                    <span class="fw-bold px-2">${i.quantity}</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(${i.productId},1)">+</button>
                    <span class="text-primary fw-bold ms-2" style="min-width:90px;text-align:right">$${(i.price*i.quantity).toLocaleString()}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${i.productId})"><i class="bi bi-trash"></i></button>
                </div>
            </div>`).join('');
    }
    const total = cart.reduce((s,i) => s+(i.price*i.quantity), 0);
    document.getElementById('cartTotal').textContent = '$' + total.toLocaleString();

    // Fix: evitar modales apilados
    const existing = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
    if (existing) {
        existing.dispose();
    }
    new bootstrap.Modal(document.getElementById('cartModal')).show();
}

function changeQty(id, delta) {
    const item = cart.find(i => i.productId === id);
    if (!item) return;
    item.quantity += delta;
    if (item.quantity <= 0) cart = cart.filter(i => i.productId !== id);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartUI();
    updateCartBody();
}

function removeFromCart(id) {
    cart = cart.filter(i => i.productId !== id);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartUI();
    updateCartBody();
}

function updateCartBody() {
    const body = document.getElementById('cartBody');
    if (!body) return;
    if (cart.length === 0) {
        body.innerHTML = '<div class="text-center py-4"><i class="bi bi-cart-x fs-1 text-muted"></i><p class="text-muted mt-2">Tu carrito est√° vac√≠o</p></div>';
    } else {
        body.innerHTML = cart.map(i => `
            <div class="cart-item-row d-flex justify-content-between align-items-center">
                <div><strong>${i.productName}</strong><div class="text-muted small">$${i.price.toLocaleString()} c/u</div></div>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(${i.productId},-1)">-</button>
                    <span class="fw-bold px-2">${i.quantity}</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(${i.productId},1)">+</button>
                    <span class="text-primary fw-bold ms-2" style="min-width:90px;text-align:right">$${(i.price*i.quantity).toLocaleString()}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${i.productId})"><i class="bi bi-trash"></i></button>
                </div>
            </div>`).join('');
    }
    const total = cart.reduce((s,i) => s+(i.price*i.quantity), 0);
    document.getElementById('cartTotal').textContent = '$' + total.toLocaleString();
}

function openCheckout() {
    bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
    document.getElementById('checkoutSummary').innerHTML = cart.map(i =>
        `<div class="d-flex justify-content-between small"><span>${i.productName} x${i.quantity}</span><span>$${(i.price*i.quantity).toLocaleString()}</span></div>`
    ).join('');
    const total = cart.reduce((s,i) => s+(i.price*i.quantity), 0);
    document.getElementById('checkoutTotal').textContent = '$' + total.toLocaleString();
    document.getElementById('paymentTotal').textContent = '$' + total.toLocaleString();
    document.getElementById('checkoutError').classList.add('d-none');
    document.getElementById('checkoutSuccess').classList.add('d-none');
    document.getElementById('stepDatos').style.display = 'block';
    document.getElementById('stepPago').style.display = 'none';
    document.getElementById('stepConfirmacion').style.display = 'none';
    document.getElementById('placeOrderBtn') && (document.getElementById('placeOrderBtn').disabled = false);
    new bootstrap.Modal(document.getElementById('checkoutModal')).show();
}

function goToPayment() {
    const name = document.getElementById('custName').value.trim();
    const email = document.getElementById('custEmail').value.trim();
    const phone = document.getElementById('custPhone').value.trim();
    const address = document.getElementById('custAddress').value.trim();
    if (!name || !email || !phone || !address) {
        const err = document.getElementById('checkoutError');
        err.textContent = 'Por favor completa todos los campos';
        err.classList.remove('d-none'); return;
    }
    document.getElementById('checkoutError').classList.add('d-none');
    const total = cart.reduce((s,i) => s+(i.price*i.quantity), 0);
    const msg = encodeURIComponent(`Hola! Soy ${name}, acabo de realizar un pedido por $${total.toLocaleString()}. Adjunto comprobante de pago Nequi. üì¶`);
    const waNumber = '573004051875'; // Cambia por tu n√∫mero de WhatsApp
    document.getElementById('whatsappLink').href = `https://wa.me/${waNumber}?text=${msg}`;
    document.getElementById('stepDatos').style.display = 'none';
    document.getElementById('stepPago').style.display = 'block';
    document.getElementById('step2Circle').className = 'rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-1';
    document.getElementById('step2Label').className = 'small fw-semibold';
}

function backToDatos() {
    document.getElementById('stepDatos').style.display = 'block';
    document.getElementById('stepPago').style.display = 'none';
}

async function placeOrder() {
    const name = document.getElementById('custName').value.trim();
    const email = document.getElementById('custEmail').value.trim();
    const phone = document.getElementById('custPhone').value.trim();
    const address = document.getElementById('custAddress').value.trim();
    try {
        const res = await fetch('/api/Orders', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ customerName: name, customerEmail: email, customerPhone: phone, customerAddress: address,
                items: cart.map(i => ({ productId: i.productId, productName: i.productName, price: i.price, quantity: i.quantity }))
            })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const total = cart.reduce((s,i) => s+(i.price*i.quantity), 0);
        const msg = encodeURIComponent(`Hola! Soy ${name}, pedido #${data.orderId} por $${total.toLocaleString()}. Adjunto comprobante. üì¶`);
        const waNumber = '573004051875';
        const wl2 = document.getElementById('whatsappLink2');
        if (wl2) wl2.href = `https://wa.me/${waNumber}?text=${msg}`;
        const cm = document.getElementById('confirmMsg');
        if (cm) cm.textContent = `Tu orden #${data.orderId} fue recibida. Total: $${data.total.toLocaleString()}`;
        const sp = document.getElementById('stepPago');
        if (sp) sp.style.display = 'none';
        const sc = document.getElementById('stepConfirmacion');
        if (sc) sc.style.display = 'block';
        const s3c = document.getElementById('step3Circle');
        if (s3c) s3c.className = 'rounded-circle bg-success text-white d-inline-flex align-items-center justify-content-center mb-1';
        const s3l = document.getElementById('step3Label');
        if (s3l) s3l.className = 'small fw-semibold text-success';
        cart = []; localStorage.removeItem('cart');
        updateCartUI(); loadProducts();
    } catch(e) {
        const err = document.getElementById('checkoutError');
        if (err) { err.textContent = 'Error: ' + e.message; err.classList.remove('d-none'); }
    }
}

function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-5 bg-dark text-white px-4 py-2 rounded-pill shadow';
    t.style.zIndex = '9999'; t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

function toggleDarkMode() {
    document.body.classList.toggle('dark');
    const btn = document.getElementById('darkBtn');
    const isDark = document.body.classList.contains('dark');
    btn.innerHTML = isDark ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
    localStorage.setItem('darkMode', isDark);
}

// Cargar preferencia guardada
if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
    document.getElementById('darkBtn') && (document.getElementById('darkBtn').innerHTML = '<i class="bi bi-sun-fill"></i>');
}
</script>
</body>
</html>